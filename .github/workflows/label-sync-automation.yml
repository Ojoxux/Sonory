name: Label Sync Automation

on:
  issues:
    types: [labeled, unlabeled]

env:
  # é€²æ—ãƒ©ãƒ™ãƒ«å®šç¾©
  PROGRESS_LABELS: '["todo", "in progress", "review", "done"]'
  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURLï¼ˆæ—¢å­˜ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨çµ±åˆï¼‰
  PROJECT_URL: https://github.com/users/Ojoxux/projects/1

jobs:
  sync-progress-labels:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Ensure single progress label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const progressLabels = JSON.parse(process.env.PROGRESS_LABELS);
            const eventLabel = context.payload.label.name;
            
            // é€²æ—ãƒ©ãƒ™ãƒ«ã®å¤‰æ›´ã§ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (!progressLabels.includes(eventLabel)) {
              console.log(`â„¹ï¸ Label '${eventLabel}' is not a progress label, skipping`);
              return;
            }
            
            // ç¾åœ¨ã®Issueãƒ©ãƒ™ãƒ«ã‚’å–å¾—
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const currentLabels = issue.labels.map(label => label.name);
            const currentProgressLabels = currentLabels.filter(label => 
              progressLabels.includes(label)
            );
            
            console.log(`Current progress labels: ${currentProgressLabels.join(', ')}`);
            
            // ãƒ©ãƒ™ãƒ«è¿½åŠ ã®å ´åˆ
            if (context.payload.action === 'labeled') {
              // è¤‡æ•°ã®é€²æ—ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹å ´åˆã€æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸã‚‚ã®ä»¥å¤–ã‚’å‰Šé™¤
              if (currentProgressLabels.length > 1) {
                const labelsToRemove = currentProgressLabels.filter(label => label !== eventLabel);
                
                for (const label of labelsToRemove) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: label
                  });
                  console.log(`ğŸ—‘ï¸ Removed duplicate progress label '${label}' from issue #${context.issue.number}`);
                }
                
                console.log(`âœ… Ensured single progress label '${eventLabel}' on issue #${context.issue.number}`);
              }
            }
            
            // ãƒ©ãƒ™ãƒ«å‰Šé™¤ã®å ´åˆ
            if (context.payload.action === 'unlabeled') {
              // é€²æ—ãƒ©ãƒ™ãƒ«ãŒå…¨ããªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§'todo'ã‚’è¿½åŠ 
              if (currentProgressLabels.length === 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['todo']
                });
                console.log(`âœ… Added default 'todo' label to issue #${context.issue.number} (no progress labels)`);
              }
            }

  # æ—¢å­˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒæœŸæ©Ÿèƒ½ã¨çµ±åˆ
  update-project-status:
    runs-on: ubuntu-latest
    needs: sync-progress-labels
    if: contains(fromJSON('["todo", "in progress", "review", "done"]'), github.event.label.name)
    steps:
      - name: Get Project Item ID
        id: get-item
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            const query = `
              query($owner: String!, $repo: String!, $issue_number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issue_number) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project { id title }
                      }
                    }
                  }
                }
              }
            `;
            const variables = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            };
            const result = await github.graphql(query, variables);
            const projectItems = result.repository.issue.projectItems.nodes;
            if (projectItems.length > 0) {
              return projectItems[0].id;
            }
            return null;

      - name: Update Project Status Based on Progress Labels
        if: steps.get-item.outputs.result
        uses: titoportas/update-project-fields@v0.1.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ secrets.PROJECT_PAT }}
          item-id: ${{ steps.get-item.outputs.result }}
          field-keys: Status
          field-values: |
            ${{
              contains(github.event.issue.labels.*.name, 'done') && 'âœ… å®Œäº†' ||
              contains(github.event.issue.labels.*.name, 'review') && 'ğŸ‘€ ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­' ||
              contains(github.event.issue.labels.*.name, 'in progress') && 'ğŸš§ é€²è¡Œä¸­' ||
              contains(github.event.issue.labels.*.name, 'todo') && 'ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰' ||
              'ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰'
            }} 