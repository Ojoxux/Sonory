name: Issue Progress Automation

on:
  issues:
    types: [opened, assigned, unassigned]

env:
  # é€²æ—ãƒ©ãƒ™ãƒ«å®šç¾©
  PROGRESS_LABELS: '["todo", "in progress", "review", "done"]'
  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURL
  PROJECT_URL: https://github.com/users/Ojoxux/projects/1
  
jobs:
  manage-issue-progress:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Add todo label on issue creation
        if: github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Issueä½œæˆæ™‚ã«è‡ªå‹•ã§todoãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['todo']
            });
            
            console.log(`âœ… Added 'todo' label to issue #${context.issue.number}`);

      - name: Update progress on assignee change
        if: github.event.action == 'assigned'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const progressLabels = JSON.parse(process.env.PROGRESS_LABELS);
            
            // ç¾åœ¨ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const currentLabels = issue.labels.map(label => label.name);
            const currentProgressLabels = currentLabels.filter(label => 
              progressLabels.includes(label)
            );
            
            // æ—¢å­˜ã®é€²æ—ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
            for (const label of currentProgressLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: label
              });
              console.log(`ğŸ—‘ï¸ Removed '${label}' label from issue #${context.issue.number}`);
            }
            
            // 'in progress'ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['in progress']
            });
            
            console.log(`âœ… Added 'in progress' label to issue #${context.issue.number}`);

      - name: Revert to todo on unassign
        if: github.event.action == 'unassigned'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const progressLabels = JSON.parse(process.env.PROGRESS_LABELS);
            
            // ç¾åœ¨ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            // ã‚¢ã‚µã‚¤ãƒ³ã•ã‚Œã¦ã„ã‚‹äººãŒã¾ã ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (issue.assignees && issue.assignees.length > 0) {
              console.log(`â„¹ï¸ Issue #${context.issue.number} still has assignees, keeping current progress status`);
              return;
            }
            
            const currentLabels = issue.labels.map(label => label.name);
            const currentProgressLabels = currentLabels.filter(label => 
              progressLabels.includes(label)
            );
            
            // æ—¢å­˜ã®é€²æ—ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
            for (const label of currentProgressLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: label
              });
              console.log(`ğŸ—‘ï¸ Removed '${label}' label from issue #${context.issue.number}`);
            }
            
            // 'todo'ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['todo']
            });
            
            console.log(`âœ… Added 'todo' label to issue #${context.issue.number} (no assignees)`);

  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åŒæœŸ
  update-project-status:
    runs-on: ubuntu-latest
    needs: manage-issue-progress
    if: github.event.action == 'assigned' || github.event.action == 'unassigned'
    steps:
      - name: Get Project Item ID
        id: get-item
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            const query = `
              query($owner: String!, $repo: String!, $issue_number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issue_number) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project { id title }
                      }
                    }
                  }
                }
              }
            `;
            const variables = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            };
            const result = await github.graphql(query, variables);
            const projectItems = result.repository.issue.projectItems.nodes;
            if (projectItems.length > 0) {
              return projectItems[0].id;
            }
            return null;

      - name: Update Project Status
        if: steps.get-item.outputs.result
        uses: titoportas/update-project-fields@v0.1.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ secrets.PROJECT_PAT }}
          item-id: ${{ steps.get-item.outputs.result }}
          field-keys: Status
          field-values: |
            ${{
              github.event.action == 'assigned' && 'ğŸš§ é€²è¡Œä¸­' ||
              github.event.action == 'unassigned' && 'ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰' ||
              'ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰'
            }} 