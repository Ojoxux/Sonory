name: Add Issue to Project with Smart Status

on:
  issues:
    types:
      - opened
      - reopened
      - labeled

env:
  PROJECT_URL: https://github.com/users/Ojoxux/projects/1

jobs:
  add-issue-with-status:
    name: Add Issue to Project with Status
    runs-on: ubuntu-latest
    steps:
      # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
      - name: Debug Info
        run: |
          echo "Project URL: ${{ env.PROJECT_URL }}"
          echo "Project ID: ${{ secrets.PROJECT_ID }}"
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Issue Labels: ${{ toJson(github.event.issue.labels) }}"
          echo "Event Action: ${{ github.event.action }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          
      - name: Add Issue to Project
        id: add-to-project
        env:
          GITHUB_PAT: ${{ secrets.PROJECT_PAT }}
          ISSUE_ID: ${{ github.event.issue.node_id }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
        run: |
          # GraphQL APIã‚’ä½¿ç”¨ã—ã¦Issueã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
          response=$(curl -s -X POST \
            -H "Authorization: bearer $GITHUB_PAT" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"mutation { addProjectV2ItemById(input: {projectId: \\\"$PROJECT_ID\\\", contentId: \\\"$ISSUE_ID\\\"}) { item { id } } }\"}" \
            https://api.github.com/graphql)
          
          echo "GraphQL Response: $response"
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰item IDã‚’æŠ½å‡º
          item_id=$(echo "$response" | jq -r '.data.addProjectV2ItemById.item.id // empty')
          
          if [ -n "$item_id" ]; then
            echo "Successfully added issue to project. Item ID: $item_id"
            echo "item_id=$item_id" >> $GITHUB_OUTPUT
          else
            echo "Failed to add issue to project"
            echo "$response" | jq '.errors // empty'
            exit 1
          fi
        
      # æˆåŠŸç¢ºèª
      - name: Confirm project addition
        if: steps.add-to-project.outputs.item_id
        run: |
          echo "âœ… Issue successfully added to project!"
          echo "Item ID: ${{ steps.add-to-project.outputs.item_id }}"
      
      # æ–°æ©Ÿèƒ½ãƒ»æ©Ÿèƒ½æ”¹å–„ã®å ´åˆ
      - name: Set Status - ã‚„ã‚‹ã“ã¨ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
        if: steps.add-to-project.outputs.item_id && (contains(github.event.issue.labels.*.name, 'feature') || contains(github.event.issue.labels.*.name, 'enhancement'))
        uses: titoportas/update-project-fields@v0.1.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ secrets.PROJECT_PAT }}
          item-id: ${{ steps.add-to-project.outputs.item_id }}
          field-keys: Status
          field-values: "ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰"
          
      # ãƒã‚°ä¿®æ­£ã®å ´åˆï¼ˆå„ªå…ˆåº¦é«˜ï¼‰
      - name: Set Status - ã‚„ã‚‹ã“ã¨ï¼ˆãƒã‚°ä¿®æ­£ï¼‰
        if: success() && contains(github.event.issue.labels.*.name, 'bug')
        uses: titoportas/update-project-fields@v0.1.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ secrets.PROJECT_PAT }}
          item-id: ${{ steps.add-to-project.outputs.item_id }}
          field-keys: Status
          field-values: "ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰"
          
      # ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãƒ»ã‚³ãƒ¼ãƒ‰æ•´ç†ã®å ´åˆ
      - name: Set Status - ã‚„ã‚‹ã“ã¨ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰
        if: success() && (contains(github.event.issue.labels.*.name, 'refactor') || contains(github.event.issue.labels.*.name, 'style') || contains(github.event.issue.labels.*.name, 'chore'))
        uses: titoportas/update-project-fields@v0.1.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ secrets.PROJECT_PAT }}
          item-id: ${{ steps.add-to-project.outputs.item_id }}
          field-keys: Status
          field-values: "ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰"
          
      # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»CI/CDé–¢é€£ã®å ´åˆ
      - name: Set Status - ã‚„ã‚‹ã“ã¨ï¼ˆãã®ä»–ï¼‰
        if: success() && (contains(github.event.issue.labels.*.name, 'documentation') || contains(github.event.issue.labels.*.name, 'ci/cd'))
        uses: titoportas/update-project-fields@v0.1.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ secrets.PROJECT_PAT }}
          item-id: ${{ steps.add-to-project.outputs.item_id }}
          field-keys: Status
          field-values: "ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰"
          
      # å„ªå…ˆåº¦ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹å ´åˆã‚‚TODOã«è¨­å®šï¼ˆå®Ÿéš›ã®ä½œæ¥­é–‹å§‹ã¯æ‰‹å‹•ã§å¤‰æ›´ï¼‰
      - name: Set Status - ã‚„ã‚‹ã“ã¨ï¼ˆå„ªå…ˆåº¦ä»˜ãï¼‰
        if: |
          success() && (
            contains(github.event.issue.labels.*.name, 'å„ªå…ˆåº¦: é«˜') ||
            contains(github.event.issue.labels.*.name, 'å„ªå…ˆåº¦: ä¸­') ||
            contains(github.event.issue.labels.*.name, 'å„ªå…ˆåº¦: ä½')
          )
        uses: titoportas/update-project-fields@v0.1.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ secrets.PROJECT_PAT }}
          item-id: ${{ steps.add-to-project.outputs.item_id }}
          field-keys: Status
          field-values: "ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰"
          
      # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆã‚¢ã‚¤ãƒ‡ã‚¢æ®µéšï¼‰
      - name: Set Status - ã‚¢ã‚¤ãƒ‡ã‚¢
        if: |
          success() && 
          !contains(github.event.issue.labels.*.name, 'feature') && 
          !contains(github.event.issue.labels.*.name, 'enhancement') && 
          !contains(github.event.issue.labels.*.name, 'bug') && 
          !contains(github.event.issue.labels.*.name, 'refactor') && 
          !contains(github.event.issue.labels.*.name, 'style') && 
          !contains(github.event.issue.labels.*.name, 'chore') && 
          !contains(github.event.issue.labels.*.name, 'documentation') && 
          !contains(github.event.issue.labels.*.name, 'ci/cd') && 
          !contains(github.event.issue.labels.*.name, 'å„ªå…ˆåº¦: é«˜') &&
          !contains(github.event.issue.labels.*.name, 'å„ªå…ˆåº¦: ä¸­') &&
          !contains(github.event.issue.labels.*.name, 'å„ªå…ˆåº¦: ä½')
        uses: titoportas/update-project-fields@v0.1.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ secrets.PROJECT_PAT }}
          item-id: ${{ steps.add-to-project.outputs.item_id }}
          field-keys: Status
          field-values: "ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚¢"

  # Issueã®ãƒ©ãƒ™ãƒ«å¤‰æ›´æ™‚ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
  update-status-on-label-change:
    name: Update Status on Label Change
    runs-on: ubuntu-latest
    if: github.event.action == 'labeled' || github.event.action == 'unlabeled'
    steps:
      - name: Get Project Item ID
        id: get-item
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            const query = `
              query($owner: String!, $repo: String!, $issue_number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issue_number) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                          title
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const variables = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            };
            
            const result = await github.graphql(query, variables);
            const projectItems = result.repository.issue.projectItems.nodes;
            
            if (projectItems.length > 0) {
              return projectItems[0].id;
            }
            return null;
            
      # ãƒ©ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
      - name: Update Status Based on Labels
        if: steps.get-item.outputs.result
        uses: titoportas/update-project-fields@v0.1.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ secrets.PROJECT_PAT }}
          item-id: ${{ steps.get-item.outputs.result }}
          field-keys: Status
          field-values: |
            ${{
              (contains(github.event.issue.labels.*.name, 'å„ªå…ˆåº¦: é«˜') || contains(github.event.issue.labels.*.name, 'å„ªå…ˆåº¦: ä¸­') || contains(github.event.issue.labels.*.name, 'å„ªå…ˆåº¦: ä½')) && 'ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰' ||
              contains(github.event.issue.labels.*.name, 'bug') && 'ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰' ||
              (contains(github.event.issue.labels.*.name, 'feature') || contains(github.event.issue.labels.*.name, 'enhancement')) && 'ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰' ||
              (contains(github.event.issue.labels.*.name, 'refactor') || contains(github.event.issue.labels.*.name, 'style') || contains(github.event.issue.labels.*.name, 'chore')) && 'ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰' ||
              (contains(github.event.issue.labels.*.name, 'documentation') || contains(github.event.issue.labels.*.name, 'ci/cd')) && 'ğŸ“ ã‚„ã‚‹ã“ã¨ï¼ˆTODOï¼‰' ||
              'ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚¢'
            }} 