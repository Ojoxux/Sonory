---
description: 
globs: 
alwaysApply: true
---
---
description: Sonory ç”¨ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹ç¯‰è¦ä»¶
alwaysApply: true
---

## ğŸš€ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¦ä»¶å®šç¾© (Cloudflare Workers + Hono + ãƒ¢ãƒãƒ¬ãƒ)

### ğŸ“¡ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­è¨ˆ

**éŸ³å£°é–¢é€£:**
```typescript
POST   /api/audio/upload     # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
GET    /api/audio/:id        # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
DELETE /api/audio/:id        # éŸ³å£°å‰Šé™¤
POST   /api/audio/:id/analyze # AIåˆ†æå®Ÿè¡Œ
```

**åœ°ç†ç©ºé–“é–¢é€£:**
```typescript
GET    /api/pins/nearby      # ç¯„å›²å†…ãƒ”ãƒ³å–å¾—
POST   /api/pins             # ãƒ”ãƒ³ä½œæˆ
POST   /api/pins/batch       # è¤‡æ•°ãƒ”ãƒ³ä¸€æ‹¬ä½œæˆ
GET    /api/pins/:id         # ãƒ”ãƒ³è©³ç´°å–å¾—
PUT    /api/pins/:id         # ãƒ”ãƒ³æ›´æ–°
DELETE /api/pins/:id         # ãƒ”ãƒ³å‰Šé™¤
GET    /api/pins/search      # æ¡ä»¶æ¤œç´¢ï¼ˆã‚«ãƒ†ã‚´ãƒªã€æ™‚é–“ç¯„å›²ç­‰ï¼‰
GET    /api/user/pins        # ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ”ãƒ³å–å¾—
POST   /api/pins/:id/report  # ä¸é©åˆ‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å ±å‘Š
```

**ã‚·ã‚¹ãƒ†ãƒ é–¢é€£:**
```typescript
GET    /api/health           # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹
GET    /api/metrics          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ï¼ˆç®¡ç†è€…ç”¨ï¼‰
```

### ğŸµ éŸ³å£°å‡¦ç†è¦ä»¶

**ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†:**
- **å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: webm, mp3, wav
- **æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: 10MB
- **éŒ²éŸ³æ™‚é–“**: 10ç§’å›ºå®š
- **åœ§ç¸®å‡¦ç†**: éŸ³è³ªä¿æŒã§ã®è»½é‡åŒ–
- **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º**: é•·ã•ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆç­‰

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³:**
```typescript
interface AudioUploadRequest {
  file: File;                    // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«
  location: {
    lat: number;                 // ç·¯åº¦ (-90 ~ 90)
    lng: number;                 // çµŒåº¦ (-180 ~ 180)
    accuracy?: number;           // GPSç²¾åº¦ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
  };
  metadata?: {
    duration?: number;           // é•·ã•ï¼ˆç§’ï¼‰
    title?: string;              // ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰
  };
}

interface SoundPinCreateRequest {
  location: {
    lat: number;                 // -90 ~ 90
    lng: number;                 // -180 ~ 180
    accuracy?: number;           // GPSç²¾åº¦ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
  };
  audio: {
    file: File;
    duration: number;            // å¿…é ˆï¼ˆ10ç§’å›ºå®šï¼‰
    format: 'webm' | 'mp3' | 'wav'; // é™å®š
  };
  context?: {
    weather?: WeatherData;       // Open-Meteo APIçµæœ
    timeTag: 'æœ' | 'æ˜¼' | 'å¤•' | 'å¤œ'; // 6æ™‚é–“åŒºåˆ‡ã‚Š
    deviceInfo?: string;         // ãƒ‡ãƒãƒƒã‚°ç”¨
  };
}

interface WeatherData {
  temperature: number;
  condition: string;            // 'sunny' | 'cloudy' | 'rainy' etc
  windSpeed?: number;
  humidity?: number;
}
```

### ğŸ¤– AIåˆ†æè¦ä»¶

**OpenAIçµ±åˆ:**
- **Whisper API**: éŸ³å£°â†’ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›
- **GPT API**: ãƒ†ã‚­ã‚¹ãƒˆåˆ†æãƒ»åˆ†é¡
- **éåŒæœŸå‡¦ç†**: Queueä½¿ç”¨

**åˆ†æçµæœ:**
```typescript
interface AIAnalysisResult {
  transcription: string;         // éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆ
  categories: {
    emotion: string;             // æ„Ÿæƒ…åˆ†æ
    topic: string;               // ãƒˆãƒ”ãƒƒã‚¯åˆ†é¡
    language: string;            // è¨€èªåˆ¤å®š
    confidence: number;          // ä¿¡é ¼åº¦
  };
  summary?: string;              // è¦ç´„ï¼ˆä»»æ„ï¼‰
}
```

### ğŸ—ºï¸ åœ°ç†ç©ºé–“å‡¦ç†è¦ä»¶

**ç©ºé–“ã‚¯ã‚¨ãƒª:**
```typescript
interface NearbyPinsQuery {
  bounds: {
    north: number;
    south: number; 
    east: number;
    west: number;
  };
  limit?: number;                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ50
  categories?: string[];         // ãƒ•ã‚£ãƒ«ã‚¿
}

interface SearchPinsQuery {
  location?: {
    lat: number;
    lng: number;
    radius: number;              // km
  };
  timeRange?: {
    start: string;               // ISO 8601
    end: string;                 // ISO 8601
  };
  categories?: string[];
  weather?: string[];
  limit?: number;
  offset?: number;
}
```

**PostGISæ´»ç”¨:**
- ç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨
- è·é›¢è¨ˆç®—æœ€é©åŒ–
- ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå†…æ¤œç´¢

### âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“:**
- ãƒ”ãƒ³å–å¾—: **100msä»¥å†…**
- éŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ**
- AIåˆ†æ: **3-10ç§’** (éåŒæœŸ)

**ä¸¦åˆ—å‡¦ç†:**
```typescript
// éŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ AIåˆ†æã®æµã‚Œ
async function processAudio(file: File, location: GeoPoint) {
  // 1. å³åº§ã«Supabase Storageã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const audioUrl = await uploadToStorage(file);
  
  // 2. ãƒ”ãƒ³ã‚’DBã«å³åº§ã«ä½œæˆï¼ˆåˆ†æå‰ï¼‰
  const pin = await createPin({ audioUrl, location });
  
  // 3. AIåˆ†æã‚’éåŒæœŸã§å®Ÿè¡Œ
  await queueAIAnalysis(pin.id, audioUrl);
  
  return pin;
}
```

### ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¦ä»¶

**Supabase Realtimeé€£æº:**
- æ–°ãƒ”ãƒ³ä½œæˆæ™‚ã®é€šçŸ¥
- AIåˆ†æå®Œäº†æ™‚ã®æ›´æ–°
- ç‰¹å®šã‚¨ãƒªã‚¢è³¼èª­è€…ã¸ã®é…ä¿¡

### ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

**ãƒ•ã‚¡ã‚¤ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:**
- MIME type ãƒã‚§ãƒƒã‚¯
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™
- æ‚ªæ„ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼

**ãƒ¬ãƒ¼ãƒˆåˆ¶é™:**
```typescript
// ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥åˆ¶é™
{
  '/api/audio/upload': '5 requests/minute',
  '/api/pins/nearby': '100 requests/minute',
  '/api/audio/analyze': '10 requests/hour',
  '/api/pins': '20 requests/minute',
  '/api/pins/search': '50 requests/minute'
}
```

### ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ¨™æº–åŒ–

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼:**
```typescript
interface APIError {
  code: string;                 // 'INVALID_AUDIO_FORMAT' ç­‰
  message: string;              // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  details?: any;                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
  timestamp: string;
  requestId: string;            // ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ç”¨
}

// æ¨™æº–ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
const ERROR_CODES = {
  // éŸ³å£°é–¢é€£
  AUDIO_TOO_LARGE: 'AUDIO_TOO_LARGE',
  INVALID_AUDIO_FORMAT: 'INVALID_AUDIO_FORMAT',
  AUDIO_DURATION_INVALID: 'AUDIO_DURATION_INVALID',
  
  // ä½ç½®é–¢é€£
  INVALID_LOCATION: 'INVALID_LOCATION',
  LOCATION_OUT_OF_BOUNDS: 'LOCATION_OUT_OF_BOUNDS',
  
  // AIåˆ†æé–¢é€£
  AI_ANALYSIS_FAILED: 'AI_ANALYSIS_FAILED',
  AI_SERVICE_UNAVAILABLE: 'AI_SERVICE_UNAVAILABLE',
  
  // ã‚·ã‚¹ãƒ†ãƒ é–¢é€£
  RATE_LIMIT_EXCEEDED: 'RATE_LIMIT_EXCEEDED',
  INTERNAL_SERVER_ERROR: 'INTERNAL_SERVER_ERROR',
  DATABASE_ERROR: 'DATABASE_ERROR',
  STORAGE_ERROR: 'STORAGE_ERROR',
} as const;
```

### ğŸ“Š ãƒ­ã‚°ãƒ»ç›£è¦–è¦ä»¶

**ãƒ­ã‚°å‡ºåŠ›:**
- API ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- ã‚¨ãƒ©ãƒ¼è©³ç´° (éŸ³å£°å‡¦ç†å¤±æ•—ç­‰)
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆ

**ãƒ¡ãƒˆãƒªã‚¯ã‚¹:**
- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸç‡
- AIåˆ†æå‡¦ç†æ™‚é–“
- åœ°ç†ç©ºé–“ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚é–“
- ã‚¨ãƒ©ãƒ¼ç‡ãƒ»ç¨®åˆ¥çµ±è¨ˆ

### ğŸ—ï¸ ãƒ¢ãƒãƒ¬ãƒæ§‹æˆ

**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :**
```
sonory/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/                  # Next.js ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆæ—¢å­˜ï¼‰
â”‚   â””â”€â”€ api/                  # Cloudflare Workers + Hono ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆæ–°è¦ï¼‰
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ routes/
â”‚       â”‚   â”‚   â”œâ”€â”€ audio.ts         # éŸ³å£°é–¢é€£API
â”‚       â”‚   â”‚   â”œâ”€â”€ pins.ts          # ãƒ”ãƒ³é–¢é€£API
â”‚       â”‚   â”‚   â””â”€â”€ health.ts        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
â”‚       â”‚   â”œâ”€â”€ services/
â”‚       â”‚   â”‚   â”œâ”€â”€ audio.service.ts # éŸ³å£°å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
â”‚       â”‚   â”‚   â”œâ”€â”€ ai.service.ts    # AIåˆ†æãƒ­ã‚¸ãƒƒã‚¯
â”‚       â”‚   â”‚   â”œâ”€â”€ geo.service.ts   # åœ°ç†ç©ºé–“å‡¦ç†
â”‚       â”‚   â”‚   â””â”€â”€ weather.service.ts # å¤©æ°—æƒ…å ±å‡¦ç†
â”‚       â”‚   â”œâ”€â”€ middleware/
â”‚       â”‚   â”‚   â”œâ”€â”€ auth.ts          # èªè¨¼
â”‚       â”‚   â”‚   â”œâ”€â”€ rateLimit.ts     # ãƒ¬ãƒ¼ãƒˆåˆ¶é™
â”‚       â”‚   â”‚   â””â”€â”€ validation.ts    # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚       â”‚   â”œâ”€â”€ utils/
â”‚       â”‚   â”‚   â”œâ”€â”€ supabase.ts      # DBæ¥ç¶š
â”‚       â”‚   â”‚   â”œâ”€â”€ storage.ts       # ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
â”‚       â”‚   â”‚   â””â”€â”€ logger.ts        # ãƒ­ã‚°å‡¦ç†
â”‚       â”‚   â”œâ”€â”€ types/
â”‚       â”‚   â”‚   â””â”€â”€ api.ts           # APIå‹å®šç¾©
â”‚       â”‚   â””â”€â”€ index.ts
â”‚       â”œâ”€â”€ package.json
â”‚       â”œâ”€â”€ tsconfig.json
â”‚       â”œâ”€â”€ wrangler.toml
â”‚       â””â”€â”€ vitest.config.ts
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ shared-types/         # ãƒ•ãƒ­ãƒ³ãƒˆãƒ»ãƒãƒƒã‚¯å…±é€šå‹å®šç¾©
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ api.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ soundPin.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ config/               # å…±é€šè¨­å®š
â”‚   â”‚   â”œâ”€â”€ biome.json
â”‚   â”‚   â”œâ”€â”€ tsconfig.base.json
â”‚   â”‚   â””â”€â”€ tailwind.config.ts
â”‚   â””â”€â”€ utils/                # å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ validation.ts
â”‚       â”‚   â”œâ”€â”€ geo.ts
â”‚       â”‚   â””â”€â”€ audio.ts
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ package.json              # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹è¨­å®š
â”œâ”€â”€ turbo.json               # Turborepoè¨­å®š
â””â”€â”€ docker-compose.yml       # é–‹ç™ºç’°å¢ƒ
```

### ğŸ”§ é–‹ç™ºç’°å¢ƒè¦ä»¶

**å¿…è¦ãƒ„ãƒ¼ãƒ«:**
- Node.js 20+
- Wrangler CLI (Cloudflare Workers)
- Turborepo (ãƒ¢ãƒãƒ¬ãƒç®¡ç†)
- Docker (é–‹ç™ºç’°å¢ƒç”¨)

**ç’°å¢ƒå¤‰æ•°:**
```bash
# Supabase
SUPABASE_URL=
SUPABASE_ANON_KEY=
SUPABASE_SERVICE_KEY=

# OpenAI
OPENAI_API_KEY=

# Cloudflare Workers
CLOUDFLARE_ACCOUNT_ID=
CLOUDFLARE_API_TOKEN=

# ãã®ä»–
NODE_ENV=development
CORS_ORIGIN=http://localhost:3000
```

### ğŸš€ å®Ÿè£…å„ªå…ˆé †ä½

1. **Phase 1**: ãƒ¢ãƒãƒ¬ãƒæ§‹é€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— + å…±é€šå‹å®šç¾©
2. **Phase 2**: åŸºæœ¬APIï¼ˆpins CRUD + ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
3. **Phase 3**: éŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ + ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
4. **Phase 4**: AIåˆ†æçµ±åˆ + éåŒæœŸå‡¦ç†
5. **Phase 5**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ + é€šçŸ¥
6. **Phase 6**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– + ç›£è¦–